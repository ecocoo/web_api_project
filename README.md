# web_api_project

## Описание проекта

Данный проект представляет собой асинхронный backend-сервис, разработанный на FastAPI, предназначенный для получения и хранения данных о курсах валют.

Сервис реализует:

* асинхронный REST API для получения данных из базы
* фоновую задачу, которая периодически получает курсы (раз в 10 минут) валют с внешнего источника (ЦБ РФ)
* WebSocket-канал для отправки обновлений клиентам в реальном времени
* интеграцию с брокером сообщений NATS для публикации и подписки на события
* асинхронную работу с базой данных SQLite

# Инструкция по запуску проекта

## Установка зависимостей

Клонировать репозиторий:

```bash
git clone https://github.com/ecocoo/web_api_project.git
cd web_api_project/
```

Создать и активировать виртуальное окружение:

```bash
python -m venv .venv
source .venv/bin/activate
```

Установить зависимости:

```bash
pip install -r requirements.txt
```

## Запуск NATS

Убедитесь, что NATS Server скачен и добавлен в репозиторий.

```bash
nats-server
```

## 3.4. Запуск приложения

Запуск FastAPI-приложения:

```bash
uvicorn app.main:app --reload
```

После запуска приложение будет доступно по адресу:

```
http://127.0.0.1:8000
```

При старте автоматически:

* создаются таблицы в базе данных
* запускается фоновая задача обновления курсов валют
* инициализируется подключение к NATS
* активируется WebSocket-сервер


# Документация по API (Swagger)

## REST API эндпоинты

Все эндпоинты, связанные с курсами валют, сгруппированы под префиксом:

```
/rates
```

### Получение курсов валют

**GET /rates/get**

Описание:
Возвращает список всех курсов валют, сохранённых в базе данных, отсортированных по дате создания (от новых к старым).

**GET /rates/get/code**

Описание:
Возвращает историю курсов для указанной валюты.

### Создание курса валют вручную

**GET /rates/create**

Описание:
Создаёт новую запись курса валюты вручную.

После создания:

* событие публикуется в NATS
* уведомление отправляется всем WebSocket-клиентам

### Удаление курса валюты

**DELETE /rates/delete**

Описание:
Удаляет курс валюты из базы данных.

После удаления:

* публикуется событие `rate_deleted`
* WebSocket-клиенты уведомляются

### Обновление курса валют

**GET /rates/update**

Описание:
Позволяет частично обновить название или значение курса валюты.

После обновления:

* отправляется событие `rate_updated`
* данные публикуются в NATS
* WebSocket-клиенты получают уведомление

### Принудительный запуск фоновой задачи

**POST /tasks/run**

Описание:
Принудительно запускает фоновую задачу обновления курсов валют.

Фоновая задача:

* делает HTTP-запрос через httpx
* сохраняет новые курсы в БД (которые изменились в цене)
* публикует события в NATS
* рассылает обновления через WebSocket

## WebSocket

### WebSocket подключение

**WS /ws/rates**

Описание:
WebSocket-канал используется для отправки клиентам уведомлений в реальном времени.

Клиент получает сообщения при:

* создании курса (`rate_created`)
* обновлении курса (`rate_updated`)
* удалении курса (`rate_deleted`)

## NATS 

Проект использует NATS как брокер сообщений.

### Публикация событий

События публикуются в каналы

События отправляются при:

* создании курса (`rate_created`)
* обновлении курса (`rate_updated`)
* удалении курса (`rate_deleted`)

### Использование

* NATS используется как источник событий
* WebSocket-уведомления синхронизируются с сообщениями из NATS